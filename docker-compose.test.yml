services:
  backend:
    container_name: fastapi_app_test
    build:
      context: .
      dockerfile: Dockerfile 
      args:
        BUILD_FOR_TEST: "true" # This tells the Dockerfile to skip installing heavy dependencies
    environment:
      APP_ENV: test
      MONGO_URL: mongodb://mongo:27017
      MONGO_USER: testuser
      MONGO_PASSWORD: testpass
    ports:
      - "8100:8000" # Use a unique host port for testing to prevent conflict
    volumes:
      - ./src:/app/src:ro
      - test_temp:/app/temp
      - test_logs:/app/logs

  mongo:
    container_name: mongo_db_test
    environment:
      MONGO_INITDB_ROOT_USERNAME: testuser
      MONGO_INITDB_ROOT_PASSWORD: testpass
    ports:
      - "27117:27017" # Use a unique host port for testing
    volumes:
      - mongo_test_data:/data/db

  nginx:
    container_name: nginx_proxy_test_disabled
    scale: 0

  certbot:
    container_name: certbot_test_disabled
    scale: 0

volumes:
  mongo_test_data:
  test_temp:
  test_logs: