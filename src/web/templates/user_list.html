<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LOTO Generator | Users</title>
<link rel="stylesheet" href="/static/css/user_list.css">
<link rel="icon" type="image/x-icon" href="/static/includes/users_icon.svg">
</head>

<body>
<header>
    <h1>All Users</h1>
    {% if current_user %}
        <p class="current-user">
            Logged in as: {{ current_user.username }} ({{ current_user.role|capitalize }})
        </p>
    {% endif %}
    
    <div class="back-div">
        <a href="{{ url_for('pdf_list') }}" class="back-btn">&#8592; Back</a>
        {% if current_user and current_user.role == "owner" %}
            <a href="/audit_logs" class="back-btn">Logs</a>
        {% endif %}
    </div>
</header>

<main>
    <div id="userList">
        <!-- JS will populate user cards here -->
    </div>
</main>

<!-- Confirmation Modal -->
<div id="confirmModal">
    <div id="confirmBox">
        <p id="confirmText"></p>
        <button id="confirmYes">Yes</button>
        <button id="confirmNo">Cancel</button>
    </div>
</div>

<script>
let pendingAction = null;   // holds a function to execute after confirmation

/** ----------------------------
 *   Fetch and Render Users
 * ---------------------------- */
async function fetchUsers() {
    const response = await fetch("/users_json", { credentials: "include" });
    const data = await response.json();
    const container = document.getElementById("userList");
    container.innerHTML = "";

    // Define role hierarchy
    const roleRank = {
        "owner": 3,
        "admin": 2,
        "user": 1
    };

    // Sort users
    data.users.sort((a, b) => {
        // Compare by role rank (descending order)
        const rankDiff = (roleRank[b.role] || 0) - (roleRank[a.role] || 0);
        if (rankDiff !== 0) return rankDiff;

        // Then alphabetically, numbers before letters (localeCompare helps)
        return a.username.localeCompare(b.username, undefined, { numeric: true, sensitivity: "base" });
    });

    data.users.forEach(user => {
        const div = document.createElement("div");
        div.classList.add("user-card");

        // Highlight the current logged-in user
        if (user.username === "{{ current_user.username }}") {
            div.classList.add("current"); // applies pastel red background
        }

        const options = {
            timeZone: "America/New_York",
            year: "numeric", month: "long", day: "numeric",
            hour: "numeric", minute: "numeric", second: "numeric",
            hour12: true
        };

        const dateCreatedEST = user.date_created ? new Date(user.date_created).toLocaleString("en-US", options) : "N/A";
        const lastAccessedEST = user.last_accessed ? new Date(user.last_accessed).toLocaleString("en-US", options) : "N/A";
        const latestResetEST = user.latest_reset ? new Date(user.latest_reset).toLocaleString("en-US", options) : "N/A";

        let actionButtonsHTML = "";

        // Only show buttons if user is not owner
        if (user.role !== "owner") {
            // Left side buttons
            let leftButtons = "";

            // Activate / Deactivate
            leftButtons += user.is_active 
                ? `<button class="btn btn-deactivate" onclick="confirmAction('Deactivate', '${user.username}', ${user.is_active}, changeActive)">Deactivate</button>`
                : `<button class="btn btn-activate" onclick="confirmAction('Activate', '${user.username}', ${user.is_active}, changeActive)">Activate</button>`;

            // Promote / Demote
            if (user.role === "user") {
                leftButtons += `<button class="btn btn-promote" onclick="confirmAction('Promote to Admin', '${user.username}', 'admin', changeRole)">Promote</button>`;
            } else if (user.role === "admin") {
                leftButtons += `<button class="btn btn-demote" onclick="confirmAction('Demote to User', '${user.username}', 'user', changeRole)">Demote</button>`;
            }

            // Right side button
            let rightButton = `<button class="btn btn-delete" onclick="confirmAction('Delete', '${user.username}', null, deleteUser)">Delete</button>`;

            // Combine into flex container
            actionButtonsHTML = `
                <div class="action-buttons">
                    <div class="left-buttons">
                        ${leftButtons}
                    </div>
                    <div class="right-buttons">
                        ${rightButton}
                    </div>
                </div>
            `;

        }


        div.innerHTML = `
            <h3>${user.display_username || user.username} ${user.role ? "(" + user.role + ")" : ""}</h3>
            <p><span>First Name:</span> ${user.first_name}</p>
            <p><span>Last Name:</span> ${user.last_name}</p>
            <p><span>Display Name:</span> ${user.display_username || ""}</p>
            <p><span>Username:</span> ${user.username}</p>
            <p><span>Email:</span> ${user.email}</p>
            <p><span>Date Created:</span> ${dateCreatedEST}</p>
            <p><span>Last Accessed:</span> ${lastAccessedEST}</p>
            <p><span>Active:</span> ${user.is_active ? "Active" : "Inactive"}</p>
            <p><span>Login Attempts:</span> ${user.login_attempts || 0}</p>
            <p><span>Backup Code:</span> ${user.backup_code || "None"}</p>
            <p><span>Password Resets:</span> ${user.password_resets || 0}</p>
            <p><span>Latest Reset:</span> ${latestResetEST}</p>
            <p><span>Verification Attempts:</span> ${user.verification_attempts || 0}</p>

            <div>
                ${actionButtonsHTML}
            </div>
        `;

        container.appendChild(div);
    });
}

/** ----------------------------
 *   Confirmation Modal Logic
 * ---------------------------- */
function confirmAction(actionText, username, state, callbackFn) {
    const modal = document.getElementById("confirmModal");
    const text = document.getElementById("confirmText");

    text.textContent = `Are you sure you want to ${actionText} ${username}?`;

    modal.style.display = "flex";

    // Store the function to run after confirmation
    pendingAction = () => callbackFn(username, state);
}

document.getElementById("confirmNo").onclick = () => {
    pendingAction = null;
    document.getElementById("confirmModal").style.display = "none";
};

document.getElementById("confirmYes").onclick = async () => {
    if (pendingAction) await pendingAction();
    document.getElementById("confirmModal").style.display = "none";
    pendingAction = null;
    fetchUsers(); // Refresh user list
};

/** ----------------------------
 *   Backend Calls
 * ---------------------------- */

// Change active status
async function changeActive(username, state) {
    const newState = state ? 0 : 1; // toggle
    await fetch("/change_status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username, is_active: newState })
    });
}

// Change role
async function changeRole(username, newRole) {
    const response = await fetch("/update_role", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username: username, role: newRole })
    });
}

// Delete User
async function deleteUser(username) {
    const response = await fetch("/delete_user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username })
    });

    if (response.ok) {
        fetchUsers();
    } else {
        const data = await response.json();
        alert(`Failed to delete user: ${data.detail || JSON.stringify(data)}`);
    }
}

fetchUsers();

// ------------------------------
// Close modal with Escape key
// ------------------------------
document.addEventListener("keydown", (e) => {
	// Check if the Escape key was pressed and the modal is currently visible
	if (e.key === "Escape" && confirmModal.style.display === "flex") {
		// Prevent default browser actions (like scrolling)
		e.preventDefault(); 
		
		// This executes the same logic as hitting "Cancel"
		pendingAction = null;
		confirmModal.style.display = "none";
		
		// Optional: refocus on the delete button or the element that opened the modal
		const deleteButton = document.getElementById("deleteBtn");
		if (deleteButton) deleteButton.focus();
	}
});
</script>
</body>
</html>
